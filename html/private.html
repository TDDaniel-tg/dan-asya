<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Private Page</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="/css/private.css" />
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º jwt-decode —á–µ—Ä–µ–∑ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
  
</head>
<body>
  <!-- –•–≠–î–ï–† -->
  <header class="header">
    <div class="burger" onclick="toggleMenu()">
      <div></div>
      <div></div>
      <div></div>
    </div>
  
    <div class="logo">
      <img src="logo.png" alt="Frag Store" />
    </div>
  
    <nav class="navigation">
      <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a>
      <div class="pages-menu" id="pagesMenu">
        <a href="#">–°—Ç—Ä–∞–Ω–∏—Ü—ã</a>
        <div class="dropdown">
          <a href="about.html">–û –Ω–∞—Å</a>
          <a href="how-to-order.html">–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</a>
          <a href="delivery-pay.html">–î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞</a>
        </div>
      </div>
      <a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
    </nav>
  
    <!-- –ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <div class="header-right">
      <div class="icons" id="login-container">
        <a href="login.html" class="icon login-icon">–í–æ–π—Ç–∏</a>
      </div>
      <div class="icons">
        <div class="icon search-icon" onclick="toggleSearch()">üîç</div>
        <a href="cart.html" class="icon cart-icon">üõí</a>
      </div>
    </div>
  
    <div class="search-bar hidden" id="searchBar">
      <input type="text" placeholder="–ü–æ–∏—Å–∫..." />
    </div>
  </header>

  <main>
    <section>
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
      <div id="userInfo"></div>
      <p>SOOOON!!!</p>
    </section>

<!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
<div class="admin-panel" id="adminAddPanel" style="display:none">
  <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
  <form id="addProductForm" enctype="multipart/form-data">
    <input type="text" name="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required />
    <input type="number" name="productPrice" placeholder="–¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞" required />
    <textarea name="productDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required></textarea>
    <input type="file" name="productImage" accept="image/*" required />
    <button type="submit" class="admin-btn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
  </form>
</div>


    <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="admin-panel" id="adminDeletePanel" style="display:none">
      <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
      <div id="products-list"></div>
    </div>
  </main>

  <script>
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–Ω—é –∏ –ø–æ–∏—Å–∫–∞
    function toggleMenu() {
      const burger = document.querySelector('.burger');
      const mobileNav = document.querySelector('.mobile-nav');
      burger.classList.toggle('open');
      if (mobileNav) mobileNav.classList.toggle('active');
    }
    const pagesMenu = document.getElementById('pagesMenu');
    if (pagesMenu) {
      pagesMenu.addEventListener('click', (event) => {
        event.stopPropagation();
        pagesMenu.classList.toggle('open');
      });
      document.addEventListener('click', () => {
        pagesMenu.classList.remove('open');
      });
    }
    function toggleSearch() {
      const searchBar = document.getElementById('searchBar');
      searchBar.classList.toggle('hidden');
    }
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const loginContainer = document.getElementById('login-container');
      const userInfo = document.getElementById('userInfo');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      try {
        const decoded = jwt_decode(token);
        userInfo.innerHTML = `<p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</p>`;
        loginContainer.innerHTML = `
          <a href="private.html" class="icon user-icon">üôç‚Äç‚ôÇÔ∏è</a>
          <button onclick="logout()" class="logout-btn">–í—ã–π—Ç–∏</button>
        `;
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
        if (decoded.role && decoded.role === 'admin') {
          document.getElementById('adminAddPanel').style.display = 'block';
          document.getElementById('adminDeletePanel').style.display = 'block';
          loadProductsForDeletion();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
        localStorage.removeItem('token');
        window.location.href = '/login.html';
      }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ —Å FormData
    const addProductForm = document.getElementById('addProductForm');
    if (addProductForm) {
      addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const formData = new FormData(addProductForm);
        try {
          const response = await fetch('/api/products', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
          const result = await response.json();
          if (response.ok) {
            alert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            addProductForm.reset();
            loadProductsForDeletion(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
          } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ' + result.message);
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', err);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.');
        }
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
    function loadProductsForDeletion() {
      const token = localStorage.getItem('token');
      fetch('/api/products', {
        headers: { 'Authorization': `Bearer ${token}` } // –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
      })
      .then(response => response.json())
      .then(products => {
        const productsListContainer = document.getElementById('products-list');
        if (products.length === 0) {
          productsListContainer.innerHTML = "<p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</p>";
        } else {
          const productsHTML = products.map(product => `
            <div class="product-item" data-id="${product._id}">
              <img src="${product.image}" alt="${product.name}">
              <div>
                <h3>${product.name}</h3>
                <p>${product.description}</p>
                <p>–¶–µ–Ω–∞: ${product.price}‚ÇΩ</p>
              </div>
              <button class="delete-btn" onclick="deleteProduct('${product._id}')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `).join("");
          productsListContainer.innerHTML = productsHTML;
        }
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", error);
      });
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    async function deleteProduct(productId) {
      const token = localStorage.getItem('token');
      if (!confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) return;
      try {
        const response = await fetch(`/api/products/${productId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        console.log("–û—Ç–≤–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:", result);
        if (response.ok) {
          alert('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω');
          loadProductsForDeletion();
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ' + result.message);
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ:", error);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.");
      }
    }
  </script>
</body>
</html>
